---
title:  "Creating a Remote FreeNAS Server"
mathjax: true
layout: post
---

![New Server](/images/X10/nas.jpg)

With the Covid pandemic keeping me at home the majority of the day, I have been sinking a lot of time into creating 
"the perfect homelab." The bulk of my time is spent doing research and planning out which piece of hardware to purchase
next. One of my favorite activities when doing research is to browse for servers/components on classified adds and get upset
and the ridiculous prices people are asking for old and outdated block heaters. Recently I decided to search for the keyword
"supermicro" on one of these sites. Supermicro is my goto brand for custom home server simply because of its availability and
industry features. It also happens to be the brand of the first motherboard I used when building my first NAS back in 2012.
Getting back onto subject, I stumbled across a listing for a diskless NAS server with all the features my current NAS has
(AES hardware accelerated encryption, Error Correcting RAM/CPU and IPMI).



# The Specs

| Part         | Description |
|--------------|-------------|
| Case         | CM 690 II |
| Processor    | Intel i3-4130 @ 3.40GHz |
| RAM          | 16 GB ECC Unbuffered DDR3 1600 |
| Motherboard  | SUPERMICRO X10SLM-F |
| LAN          | Dual Intel Gigabit |
| Controller   | DELL H310 |
| PSU          | SeaSonic 360W, Gold Certified |


## Accessing the IPMI
The Intelligent Platform Management Interface (IPMI) is typically the first thing I want to get access to when setting
up a new server. This allows me to perform changes to the BIOS, boot from an ISO file and do hard start/stop/restarts
remotely. With the lack of a KVM switch using a mouse & keyboard is not very convenient or comfortable with my current
setup. The previous owner of this server mentioned the IPMI credentials have been changed and he did not remember what he had
set them to. So I went in wit the mindset of using my DOS USB key with the IPMICFG.exe binary I had setup/downloaded
back in 2012. 


### Troubleshooting
When plugging in the USB key and hitting the power button, the computer failed to power on. With the
heartbeat LED on the motherboard blinking, I figured it was safe to assume it wasen't an issue with the internal hardware.
My first guess was that the front pannels power button was broken. When try to short the power jumpers manually I
was shocked that the server still would not power on. I had already hooked up the network ports and noticed the IPMI LEDs
were blinking on my switch and motherboard. So I figured the issue was with the jumpers and perhaps I could power on the
system via the IPMI module. Lucky for me the MAC address for the IPMI port was written on the motherboard, so I plugged my
desktop into the same network switch in an attempt to get the IP address using `arp -a`. Once again no luck. Before I could
continue I buddie of mine called me and I mentioned the issue I ran into, he said perhaps the "power-on" pins on the PSU could
be faulty. Being the quickes thing to test, I disconnected all the cables from the motherboard and jumped the power-on pins.
The PSU fan started, leaving me to still believe it was a fault with the jumper pins for the cases front pannel. After plugging
the PSU cables back into the motherboard and fliping the power switch the server started. It turns out the cables probably
came lose while driving it home. Leasson learned, next time a computer does not power-on try reseating the cables first.

### Reseting the IPMI module
Now that the server was running I could finally boot into DOS and reset the IPMI interface to factory defaults. First things
first I used the help flag, as it has been 8 years since I have used this tool, and got the current IP address of the IPMI module
using the following commands:

```
IPMICFG -h
IPMICFG -m
```

The IP address was static out of my networks subnet. I also noticed that arp was set to off which explains why I could not 
find the device using `arp -a`. So I ran the following commands to reset the chip to factory defaults, preventing me from
messing around with changing the admin password via the CLI. I also enabled DHCP removing the need for me to memorize
any IP address and to validate there are no IP conflicts with other devices on the network.

```
IPMICFG -fd
IPMICFG -dhcp
IPMICFG -dhcp on
```

## Testing the Hardware

![memtest](/images/X10/memtest.png)

Now that I can remote into the servers console from the comfort of my office I decided to begin my routine with any new server.
First off I ran Memtest86 to validate the RAM modules were working as expected. Since I will be using ZFS as the filesystem
on this NAS server faulty memory can lead to some pretty nasty issues. I also opted to run CPUstress to see how well the 
the CPUs thermals were under load.

## Setting up FreeNAS and Replication


## Removing iSCUSI Nodes
I noticed after deleting all my iscuis devices from FreeNAS my server was getting hungup trying to connect
to old targets. a simple `ls /etc/iscsi/nodes` gave me a list of all the ign's my VM was trying to connect
to at boot. Removing them was as simple as running `iscsiadm -m node -o delete -T <iqn>` [source](https://support.unitrends.com/UnitrendsBackup/s/article/000003999)

https://www.supermicro.com/en/solutions/management-software/ipmi-utilities
https://www.supermicro.com/manuals/other/IPMI_Users_Guide.pdf